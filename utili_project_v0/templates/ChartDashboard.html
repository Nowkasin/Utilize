<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- โหลด Google Charts library -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <!-- โหลดฟอนต์ Kanit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- โหลด Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // กำหนดค่า Tailwind CSS (ฟอนต์, สี)
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Kanit', 'sans-serif'] },
          colors: {
            'primary-blue': '#1a73e8',
            'capex-red': '#DC2626',
            'capex-dark': '#374151',
            'monthly-rev-green': '#10B981',
            'monthly-exp-orange': '#F59E0B',
            'dep-gray': '#6B7280',
            'cum-exp-purple': '#9333EA',
          }
        }
      }
    }
  </script>
  <style>
    /* CSS ทั่วไปสำหรับ Body, Container, และ Styles อื่นๆ */
    body { max-width:100%; overflow-x:hidden; }
    .chart-container { height:100%; width:100%; }
    .clickable-row:hover { background-color: #f0f9ff; cursor: pointer; } /* (Style นี้ไม่ได้ใช้แล้ว แต่เก็บไว้เผื่อ) */
    .filter-active { background-color: #dbeafe; font-weight:bold; }
    /* [ลบ] .chart-grid-container { min-height:900px; } */
    /* CSS สำหรับ Spinner Loading */
    .spinner { border:4px solid #f3f3f3; border-top:4px solid #1a73e8; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto; }
    @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .loading-container { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; min-height:200px; text-align:center; color:#6B7280; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 font-sans antialiased">
<div class="max-w-7xl mx-auto">
<!-- ส่วนหัวของ Dashboard -->
<h4 class="text-3xl font-extrabold mb-4 text-primary-blue border-b-4 border-primary-blue pb-2 tracking-tight">
  กราฟวิเคราะห์จุดคุ้มทุน (Break-Even Analysis) เครื่องมือแพทย์
</h4>

<!-- ส่วน Dropdowns สำหรับเลือกเครื่องมือ -->
<div class="mb-6 bg-white p-4 rounded-xl shadow-lg border border-gray-200">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label for="bmeNameSelector" class="block text-lg font-bold text-gray-700 mb-2">1. เลือกชื่อเครื่อง:</label>
      <select id="bmeNameSelector" onchange="onBmeNameChange()"
              class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out text-gray-800 text-base">
        <option value="">-- กำลังโหลด --</option>
      </select>
    </div>
    <div>
      <label for="brandModelSelector" class="block text-lg font-bold text-gray-700 mb-2">2. เลือก Brand/Model:</label>
      <select id="brandModelSelector" onchange="onBrandModelChange()" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out text-gray-800 text-base" disabled>
        <option value="">--</option>
      </select>
    </div>
    <div>
      <label for="aeTitleSelector" class="block text-lg font-bold text-gray-700 mb-2">3. เลือก AE Title:</label>
      <select id="aeTitleSelector" onchange="onAeTitleChange()" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:ring-primary-blue focus:border-primary-blue transition duration-150 ease-in-out text-gray-800 text-base" disabled>
        <option value="">--</option>
      </select>
    </div>
  </div>
  <p id="chartTitle" class="mt-3 text-sm text-gray-500 italic">โปรดเลือกเครื่องมือแพทย์ให้ครบ 3 ขั้นตอน</p>
</div>

<!-- ส่วนแสดงผลกราฟ (Layout Grid) -->
<div class="lg:grid lg:grid-cols-3 lg:gap-6">
  
  <!-- [แก้ไข] คอลัมน์ซ้าย (กราฟสะสม และ กราฟรายเดือน) - เอา grid-rows-5 ออก -->
  <div class="lg:col-span-2 w-full flex flex-col gap-6">
    <!-- [แก้ไข] กำหนดความสูงที่เหมาะสม -->
    <div id="chart_cumulative_container" class="w-full bg-white border border-gray-200 rounded-xl shadow-xl p-3" style="height: 550px;">
      <!-- กราฟสะสม (Cumulative Chart) -->
      <div id="chart_div_cumulative" class="chart-container">
        <div class="loading-container"><div class="text-xl text-gray-500">โปรดเลือกเครื่องมือแพทย์</div></div>
      </div>
    </div>
    <!-- [แก้ไข] กำหนดความสูงที่เหมาะสม -->
    <div id="chart_monthly_container" class="w-full bg-white border border-gray-200 rounded-xl shadow-xl p-3" style="height: 450px;">
      <!-- กราฟรายเดือน (Monthly Chart) -->
      <div id="chart_div_monthly" class="chart-container">
        <div class="loading-container"><div class="text-xl text-gray-500">โปรดเลือกเครื่องมือแพทย์</div></div>
      </div>
    </div>
  </div>

  <!-- [แก้ไข] คอลัมน์ขวา (เดิมคือ table_div) - ตอนนี้เป็นที่อยู่ของกราฟรายละเอียดหัตถการ -->
  <!-- [แก้ไข] เพิ่ม style="height: 550px;" และ class "flex flex-col" -->
  <div id="chart_details_container" class="lg:col-span-1 w-full bg-white border border-gray-200 rounded-xl shadow-xl p-3 mt-6 lg:mt-0 flex flex-col" style="height: 550px;">
    <h5 id="table_title" class="text-xl font-bold text-gray-800 mb-3">รายละเอียดหัตถการ</h5>
    <div id="filter_status" class="mb-3">
      <p class="text-sm text-gray-500 italic">คลิกที่กราฟรายเดือน (เดือน) หรือกราฟหัตถการ (Service) เพื่อกรองข้อมูล</p>
    </div>

    <!-- [แก้ไข] ส่วนนี้คือที่สำหรับวาดกราฟรายละเอียดหัตถการ (ปรับความสูง) -->
    <!-- [แก้ไข] ลบ style="height:600px;" ออก, เพิ่ม class "flex-grow" และ "min-height" เพื่อให้ยืดหยุ่น -->
    <div id="chart_div_service_details" class="chart-container flex-grow" style="height:auto; min-height:300px;">
      <div class="loading-container" style="height:100%;">
        <div class="text-xl text-gray-500">โปรดเลือกเครื่องมือแพทย์</div>
      </div>
    </div>
    
    <!-- [เพิ่ม] ส่วน Pagination สำหรับกราฟหัตถการ -->
    <div id="service_pagination_controls" class="flex justify-between items-center mt-2" style="display: none;">
      <button id="btn_prev_service" onclick="changeServicePage(-1)" class="px-4 py-2 bg-gray-200 rounded-lg shadow hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">&lt; ก่อนหน้า</button>
      <span id="service_page_indicator" class="text-sm text-gray-600"></span>
      <button id="btn_next_service" onclick="changeServicePage(1)" class="px-4 py-2 bg-gray-200 rounded-lg shadow hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">ถัดไป &gt;</button>
    </div>

  </div>
  <!-- [สิ้นสุดการแก้ไข HTML] -->

</div>

<script>
  // ฟังก์ชันแปลงตัวเลขเป็น Short Format (K, M, B)
  function formatShortNumber(num){
    if(!num) return '0';
    if(num >= 1e9) return (num/1e9).toFixed(2)+'B';
    if(num >= 1e6) return (num/1e6).toFixed(2)+'M';
    if(num >= 1e3) return (num/1e3).toFixed(2)+'K';
    return num.toLocaleString();
  }

  // [ลบ] ฟังก์ชัน updateDetailsTable (ที่เคยอยู่ใน HTML) ถูกลบออกจากส่วนนี้
  // เราจะสร้างฟังก์ชัน drawServiceDetailsChart ใน script หลักแทน
</script>


<script>
// โหลด Google Charts package 'corechart'
google.charts.load('current', {'packages':['corechart']});
// เมื่อโหลดเสร็จ ให้เรียกฟังก์ชัน loadData
google.charts.setOnLoadCallback(loadData);

// --- ตัวแปร Global ---
let bmeMap = {}, deviceHierarchy = {}, sapMap = {}, pacsDataDetails = [], allUniqueDates = [], todayStr = null;
let chartMonthly = null, chartCumulative = null;
// [เพิ่ม] เพิ่มตัวแปรสำหรับเก็บ object ของกราฟหัตถการ
let chartServiceDetails = null; 
// ตัวแปรเก็บค่าฟิลเตอร์ปัจจุบัน
let currentBmeName = null, currentBrandModel = null, currentAeTitle = null;
let currentMonthFilter = null, currentServiceFilter = null;
// [เพิ่ม] ตัวแปรสำหรับเก็บข้อมูลที่สรุปแล้วของ Service เพื่อใช้ในการ lookup serviceCode จาก row index
let sortedServiceSummary = []; 
// [เพิ่ม] ตัวแปรสำหรับ Pagination
let serviceDetailsPage = 0;
const SERVICE_PAGE_SIZE = 5;

// --- 1. FETCH INITIAL DATA ---
// (ดึงข้อมูลเริ่มต้นสำหรับ Dropdowns)
function loadData() {
  fetch('/api/initial-data')
    .then(r=>r.ok?r.json():Promise.reject(r.statusText))
    .then(data=>initializeDashboard(data))
    .catch(err=>showError(err));
}

// --- 2. INITIALIZE DASHBOARD ---
// (ตั้งค่า Dropdowns เมื่อข้อมูลเริ่มต้นมาถึง)
function initializeDashboard(dataObject){
  if(dataObject.error){ showError(dataObject.error); return; }
  bmeMap = dataObject.bmeMap;
  for(const ae in bmeMap){ if(bmeMap[ae].installDate) bmeMap[ae].installDate=new Date(bmeMap[ae].installDate); }

  deviceHierarchy={};
  for(const ae in bmeMap){
    const dev=bmeMap[ae], bme=dev.bmeName||"Unknown", brandModel=`${dev.brand||"N/A"} | ${dev.model||"N/A"}`;
    if(!deviceHierarchy[bme]) deviceHierarchy[bme]={};
    if(!deviceHierarchy[bme][brandModel]) deviceHierarchy[bme][brandModel]=[];
    deviceHierarchy[bme][brandModel].push(ae);
  }

  const bmeNames = Object.keys(deviceHierarchy).sort();
  const bmeSelect=document.getElementById('bmeNameSelector');
  if(!bmeNames.length){ bmeSelect.innerHTML='<option>ไม่พบเครื่องมือแพทย์</option>'; showError("ไม่พบข้อมูล AE Title"); return; }
  bmeSelect.innerHTML='<option value="">-- 1. เลือกชื่อเครื่อง --</option>';
  bmeNames.forEach(bme=>{const o=document.createElement('option');o.value=bme;o.textContent=bme;bmeSelect.appendChild(o);});

  document.getElementById('brandModelSelector').innerHTML='<option value="">-- 2. เลือก Brand/Model --</option>';
  document.getElementById('aeTitleSelector').innerHTML='<option value="">-- 3. เลือก AE Title --</option>';
  document.getElementById('brandModelSelector').disabled=true;
  document.getElementById('aeTitleSelector').disabled=true;

  clearView();
}

// --- 3. DROPDOWN HANDLERS ---
// (จัดการการเปลี่ยนแปลงค่าใน Dropdowns)
function onBmeNameChange(){ 
  currentBmeName=document.getElementById('bmeNameSelector').value; currentBrandModel=null; currentAeTitle=null;
  const brandModelSelect=document.getElementById('brandModelSelector');
  const aeSelect=document.getElementById('aeTitleSelector');
  brandModelSelect.innerHTML='<option>-- 2. เลือก Brand/Model --</option>'; aeSelect.innerHTML='<option>-- 3. เลือก AE Title --</option>'; aeSelect.disabled=true;

  if(currentBmeName && deviceHierarchy[currentBmeName]){
    brandModelSelect.disabled=false;
    Object.keys(deviceHierarchy[currentBmeName]).sort().forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;brandModelSelect.appendChild(o);});
  } else brandModelSelect.disabled=true;
  clearView();
}

function onBrandModelChange(){
  currentBrandModel=document.getElementById('brandModelSelector').value; currentAeTitle=null;
  const aeSelect=document.getElementById('aeTitleSelector'); aeSelect.innerHTML='<option>-- 3. เลือก AE Title --</option>';
  if(currentBmeName && currentBrandModel && deviceHierarchy[currentBmeName][currentBrandModel]){
    aeSelect.disabled=false;
    deviceHierarchy[currentBmeName][currentBrandModel].forEach(ae=>{const o=document.createElement('option');o.value=ae;o.textContent=ae;aeSelect.appendChild(o);});
  } else aeSelect.disabled=true;
  clearView();
}

// เมื่อเลือก AE Title (ขั้นตอนสุดท้าย)
function onAeTitleChange(){
  currentAeTitle=document.getElementById('aeTitleSelector').value; 
  currentMonthFilter=null; 
  currentServiceFilter=null;
  serviceDetailsPage = 0; // [เพิ่ม] รีเซ็ตหน้าเมื่อเลือกเครื่องใหม่
  if(!currentAeTitle){ clearView(); return; }
  showLoadingSpinner();
  // ดึงข้อมูลสำหรับเครื่องที่เลือก
  fetch(`/api/device-data/${currentAeTitle}`)
    .then(r=>r.ok?r.json():Promise.reject(r.statusText))
    .then(data=>handleDeviceData(data))
    .catch(err=>showError(err));
}

// --- 4. HANDLE DEVICE DATA ---
// (เมื่อข้อมูลเครื่องมาถึง)
function handleDeviceData(data){
  if(data.error){ showError(data.error); return; }
  sapMap=data.sapMap||{}; pacsDataDetails=data.pacsDataDetails||[]; allUniqueDates=data.allUniqueDates||[]; todayStr=data.todayStr||null;
  // วาดกราฟและตาราง (ตอนนี้คือ กราฟ 3 ตัว)
  drawChartAndTable();
}

// --- 5. VIEW CONTROL FUNCTIONS ---
// (ฟังก์ชันสำหรับล้าง/แสดงผลหน้าจอ)

// ล้าง View (กลับไปหน้าเริ่มต้น)
function clearView(){
  const placeholder=`<div class="loading-container"><div class="text-xl text-gray-500">โปรดเลือกเครื่องมือแพทย์ให้ครบ 3 ขั้นตอน</div></div>`;
  document.getElementById('chart_div_cumulative').innerHTML=placeholder;
  document.getElementById('chart_div_monthly').innerHTML=placeholder;
  // [แก้ไข] ล้างกราฟหัตถการด้วย
  document.getElementById('chart_div_service_details').innerHTML=placeholder.replace('style="height:100%;"', '');
  document.getElementById('chartTitle').textContent='โปรดเลือกเครื่องมือแพทย์ให้ครบ 3 ขั้นตอน';
  currentMonthFilter=null; currentServiceFilter=null; updateFilterStatus();
}

// แสดง Spinner ขณะโหลด
function showLoadingSpinner(){
  const spinner=`<div class="loading-container"><div class="spinner"></div><p class="text-lg text-gray-600 mt-4">กำลังโหลดข้อมูลเครื่อง...</p></div>`;
  const spinnerSmall = `<div class="loading-container" style="height:800px;"><div class="spinner"></div></div>`;
  document.getElementById('chart_div_cumulative').innerHTML=spinner;
  document.getElementById('chart_div_monthly').innerHTML=spinner;
  // [แก้ไข] แสดง spinner ในกราฟหัตถการด้วย
  document.getElementById('chart_div_service_details').innerHTML=spinnerSmall;
}

// [เพิ่ม] ฟังก์ชันสำหรับแสดง Error
function showError(error) {
  console.error("Dashboard Error:", error); // Log error ที่ console
  const errorMessage = `<div class="loading-container" style="height:100%;"><div class="text-xl text-red-600 font-bold">เกิดข้อผิดพลาด</div><p class="text-gray-700 mt-2 p-4">${error.toString()}</p></div>`;
  
  // แสดง error ใน container หลัก
  try {
    document.getElementById('chart_div_cumulative').innerHTML = errorMessage;
    document.getElementById('chart_div_monthly').innerHTML = errorMessage;
    document.getElementById('chart_div_service_details').innerHTML = errorMessage;
  } catch (e) {
    // Fallback (เผื่อ DOM ยังไม่พร้อม)
    console.error("Could not display error in UI", e);
  }
}

// --- 6. AGGREGATE DATA FOR CHART ---
// (เตรียมข้อมูลสำหรับกราฟ สะสม และ รายเดือน)
function aggregateDataForChart(aeTitle, serviceFilter){
  const bmeData=bmeMap[aeTitle]; if(!bmeData) return [];
  const { capEx, monthlyDep, depMonths, orderNum }=bmeData;
  // กรองข้อมูล PACS ตาม serviceFilter (ถ้ามี)
  const filteredPacs=pacsDataDetails.filter(d=>d.aeTitle===aeTitle && (!serviceFilter||d.serviceCode===serviceFilter));
  const monthlyRevenueMap=new Map(); filteredPacs.forEach(item=>{monthlyRevenueMap.set(item.yearMonth,(monthlyRevenueMap.get(item.yearMonth)||0)+item.revenuePL);});
  
  let cumRevenuePL=0, cumExpenseSAP=0, depCounter=0; const finalSeriesData=[];
  for(const dateStr of allUniqueDates){
    const yearMonth=dateStr.substring(0,7);
    const isFuture=todayStr&&dateStr>todayStr;
    const lineStyle=isFuture?'stroke-dasharray: 4 4; opacity: 0.2;':null;
    // [แก้ไข] แก้ไขสี 'fill: #CB;' เป็น 'fill: #CCCCCC;' (Hex code ที่ถูกต้อง)
    const barStyle=isFuture?'fill: #CCCCCC; opacity: 0.5;':null;

    const monthlyRevenuePL=isFuture?0:(monthlyRevenueMap.get(yearMonth)||0); cumRevenuePL+=monthlyRevenuePL;
    // ถ้ามี serviceFilter, จะไม่แสดง monthlyExpenseSAP และ fixedDep
    const sapKey=`${orderNum}-${yearMonth}`; const monthlyExpenseSAP=(isFuture||serviceFilter)?0:(sapMap[sapKey]||0); cumExpenseSAP+=monthlyExpenseSAP;
    let fixedDep=0, fixedCapEx=capEx;
    if(depCounter<depMonths){ fixedDep=!serviceFilter?monthlyDep:0; depCounter++; }
    finalSeriesData.push([new Date(dateStr), monthlyRevenuePL, barStyle, cumRevenuePL, lineStyle, monthlyExpenseSAP, barStyle, cumExpenseSAP, lineStyle, fixedCapEx, lineStyle, fixedDep, lineStyle]);
  }
  return finalSeriesData;
}

// --- 7. GET 3-YEAR INITIAL RANGE ---
// (คำนวณช่วงเวลา 3 ปีเริ่มต้นสำหรับ Zoom ของกราฟ)
function getInitialDateRange(aeTitle){
  const bmeData=bmeMap[aeTitle]; if(!bmeData||!bmeData.installDate) return null;
  const start=new Date(bmeData.installDate); const end=new Date(start); end.setFullYear(start.getFullYear()+3);
  return {start,end};
}

// --- 8. DRAW CHARTS (Main Function) ---
// (ฟังก์ชันหลักในการวาด/อัปเดตกราฟทั้งหมด)
function drawChartAndTable(){
  if(!currentAeTitle) return;
  const displayTitle=`${currentBmeName} [${currentBrandModel}] (${currentAeTitle})`;
  document.getElementById('chartTitle').textContent=`แสดงกราฟวิเคราะห์สำหรับ: ${displayTitle}`;
  
  // 8.1 เตรียมข้อมูลสำหรับกราฟสะสม/รายเดือน
  const seriesData=aggregateDataForChart(currentAeTitle, currentServiceFilter);
  if(!seriesData||!seriesData.length){ showError("ไม่พบข้อมูล"); return; }

  // 8.2 สร้าง DataTable สำหรับกราฟสะสม/รายเดือน
  const data=new google.visualization.DataTable();
  data.addColumn('date','Date'); data.addColumn('number','Monthly Revenue (P/L)'); data.addColumn({type:'string',role:'style'});
  data.addColumn('number','Cumulative Revenue (P/L)'); data.addColumn({type:'string',role:'style'});
  data.addColumn('number','Monthly Expense (SAP)'); data.addColumn({type:'string',role:'style'});
  data.addColumn('number','Cumulative Expense (SAP)'); data.addColumn({type:'string',role:'style'});
  data.addColumn('number','CAPEX (Break-Even)'); data.addColumn({type:'string',role:'style'});
  data.addColumn('number','Monthly Depreciation'); data.addColumn({type:'string',role:'style'});
  data.addRows(seriesData);

  // 8.3 วาดกราฟสะสม และ กราฟรายเดือน
  drawMonthlyChart(data, displayTitle);
  drawCumulativeChart(data, displayTitle);
  
  // 8.4 [แก้ไข] วาดกราฟรายละเอียดหัตถการ (แทนที่ updateDetailsTable)
  drawServiceDetailsChart(currentAeTitle, currentMonthFilter, currentServiceFilter);

  // 8.5 อัปเดตสถานะฟิลเตอร์
  updateFilterStatus();
}

// --- 9. DRAW MONTHLY CHART ---
// (วาดกราฟรายเดือน)
function drawMonthlyChart(fullData, displayTitle){
  const range = getInitialDateRange(currentAeTitle);
  const view = new google.visualization.DataView(fullData);
  view.setColumns([0,1,2,5,6,11,12]);

  const options = {
    title: `รายเดือน: ${displayTitle}`,
    legend: { position: 'bottom' },
    chartArea: { width: '85%', height: '70%' },
    backgroundColor: { fill: '#fff' },
    vAxis: { title: 'จำนวนเงิน (บาท)', format: 'short' },
    hAxis: { title: 'วันที่', format: 'MMM yyyy', viewWindow: range ? { min: range.start, max: range.end } : undefined },
    seriesType: 'bars',
    series: {
      0: { type: 'bars', color: '#10B981' }, // Monthly Revenue
      1: { type: 'bars', color: '#F59E0B' }, // Monthly Expense
      2: { type: 'line', lineWidth: 3, pointSize: 0, color: '#6B7280', lineDashStyle: [4,4] } // Depreciation
    },
    bar: { groupWidth: '90%' },
    explorer: { axis: 'horizontal', keepInBounds: true, maxZoomIn: 0.1 }
  };

  if (!chartMonthly) chartMonthly = new google.visualization.ComboChart(document.getElementById('chart_div_monthly'));
  chartMonthly.draw(view, options);

  // Event Listener: เมื่อคลิกกราฟรายเดือน
  google.visualization.events.addListener(chartMonthly, 'select', function() {
    const sel = chartMonthly.getSelection();
    if(sel.length > 0){
      const row = sel[0].row;
      if(row != null){
        const date = fullData.getValue(row,0);
        const selectedMonth = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
        // Toggle filter: ถ้าคลิกเดือนเดิม ให้ยกเลิก
        currentMonthFilter = (currentMonthFilter === selectedMonth) ? null : selectedMonth;
        serviceDetailsPage = 0; // [เพิ่ม] รีเซ็ตหน้าเมื่อคลิก
        // วาดทุกอย่างใหม่
        drawChartAndTable();
      }
    }
  });
}

// --- 10. DRAW CUMULATIVE CHART ---
// (วาดกราฟสะสม)
function drawCumulativeChart(fullData, displayTitle){
  const range = getInitialDateRange(currentAeTitle);
  const view = new google.visualization.DataView(fullData);
  view.setColumns([0, 3, 4, 7, 8, 9, 10]);

  const options = {
    title: `สะสม: ${displayTitle}`,
    legend: { position: 'bottom' },
    chartArea: { width: '85%', height: '70%' },
    backgroundColor: { fill: '#fff' },
    vAxis: { title: 'จำนวนเงิน (บาท)', format: 'short' },
    hAxis: { title: 'วันที่', format: 'MMM yyyy', viewWindow: range ? { min: range.start, max: range.end } : undefined },
    seriesType: 'line',
    series: {
      0: { color: '#1a73e8', lineWidth: 2, pointSize: 5 }, // Cumulative Revenue
      1: { color: '#F59E0B', lineWidth: 2, pointSize: 5 }, // Cumulative Expense
      2: { color: '#6B7280', lineWidth: 2, lineDashStyle: [4, 4], pointSize: 0 } // CAPEX
    },
    explorer: { axis: 'horizontal', keepInBounds: true, maxZoomIn: 0.1 }
  };

  if(!chartCumulative) chartCumulative = new google.visualization.ComboChart(document.getElementById('chart_div_cumulative'));
  chartCumulative.draw(view, options);

  // Event Listener: เมื่อคลิกกราฟสะสม (ทำงานเหมือนกราฟรายเดือน)
  google.visualization.events.addListener(chartCumulative, 'select', function() {
    const sel = chartCumulative.getSelection();
    if(sel.length > 0){
      const row = sel[0].row;
      if(row != null){
        const date = fullData.getValue(row,0);
        const selectedMonth = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
        currentMonthFilter = (currentMonthFilter === selectedMonth) ? null : selectedMonth;
        serviceDetailsPage = 0; // [เพิ่ม] รีเซ็ตหน้าเมื่อคลิก
        drawChartAndTable();
      }
    }
  });
}


// --- [ฟังก์ชันใหม่] 11. DRAW SERVICE DETAILS CHART ---
// (แทนที่ฟังก์ชัน updateDetailsTable เดิม)
function drawServiceDetailsChart(aeTitle, monthFilter, serviceFilter) {
  
  // 1. กรองข้อมูลตาม AE Title และ เดือน (Month)
  // **หมายเหตุ:** เราจะไม่กรองด้วย serviceFilter ที่นี่
  // เพื่อให้กราฟแสดง service ทั้งหมดในเดือนที่เลือก (ถ้ามี)
  const filtered = pacsDataDetails.filter(d =>
    d.aeTitle === aeTitle &&
    (!monthFilter || d.yearMonth === monthFilter)
  );

  const container = document.getElementById('chart_div_service_details');
  if (!filtered.length) {
    container.innerHTML = '<div class="loading-container" style="height:100%;"><div class="text-xl text-gray-500">ไม่พบข้อมูลหัตถการ</div></div>';
    return;
  }

  // 2. สรุปรวมข้อมูล (Aggregate) ตาม Service Code
  const serviceSummary = new Map();
  filtered.forEach(d => {
    const key = d.serviceCode || '-';
    if (!serviceSummary.has(key)) {
      serviceSummary.set(key, {
        serviceCode: key,
        serviceName: d.serviceName || '-',
        totalCount: 0,
        totalRevenuePL: 0
      });
    }
    const summary = serviceSummary.get(key);
    summary.totalCount += (d.orderQty || 0);
    summary.totalRevenuePL += (d.revenuePL || 0);
  });

  // 3. แปลง Map เป็น Array และเรียงลำดับ (ตามรายได้สูงสุด)
  // [แก้ไข] เราเก็บผลลัพธ์นี้ไว้ใน Global (sortedServiceSummary) เพื่อใช้ใน click handler
  sortedServiceSummary = Array.from(serviceSummary.values())
    .sort((a, b) => b.totalRevenuePL - a.totalRevenuePL);

  // [เพิ่ม] 3.5 คำนวณ Pagination
  const totalItems = sortedServiceSummary.length;
  const totalPages = Math.ceil(totalItems / SERVICE_PAGE_SIZE);
  
  // (ตรวจสอบเผื่อหน้าปัจจุบันหายไปหลัง Filter)
  if (serviceDetailsPage * SERVICE_PAGE_SIZE >= totalItems) {
    serviceDetailsPage = 0;
  }
  
  const startIndex = serviceDetailsPage * SERVICE_PAGE_SIZE;
  const paginatedSummary = sortedServiceSummary.slice(startIndex, startIndex + SERVICE_PAGE_SIZE);


  // 4. สร้าง DataTable
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Service');
  data.addColumn('number', 'จำนวน (ครั้ง)');
  data.addColumn({type: 'string', role: 'style'}); // Style สำหรับ Count
  data.addColumn('number', 'รายได้ (P/L)');
  data.addColumn({type: 'string', role: 'style'}); // Style สำหรับ Revenue
  // [เพิ่ม] เพิ่มคอลัมน์ Tooltip เพื่อแสดงข้อมูลทั้งหมด
  data.addColumn({type: 'string', role: 'tooltip'});

  // 5. เพิ่มข้อมูลลงใน DataTable พร้อม Style (จากข้อมูลที่แบ่งหน้าแล้ว)
  paginatedSummary.forEach(d => {
    // [แก้ไข] ป้ายกำกับ (Label) บนแกน X ให้แสดงเฉพาะ Service Code
    const serviceCodeLabel = d.serviceCode || '-';
    const count = d.totalCount;
    const revenue = d.totalRevenuePL;
    
    // [เพิ่ม] สร้าง Tooltip ที่จะแสดงเมื่อ Hover
    const tooltipText = `หัตถการ: [${d.serviceCode}] ${d.serviceName || '-'}\nจำนวน: ${count.toLocaleString()} ครั้ง\nรายได้: ${formatShortNumber(revenue)} บาท`;

    // กำหนด Style
    const isSelected = (d.serviceCode === serviceFilter);
    const opacity = (!serviceFilter || isSelected) ? '1.0' : '0.3';
    const countColor = isSelected ? '#3b82f6' : '#10B981'; // สีน้ำเงินเข้มเมื่อเลือก, เขียวปกติ
    const revenueColor = isSelected ? '#3b82f6' : '#1a73e8'; // สีน้ำเงินเข้มเมื่อเลือก, น้ำเงินปกติ

    const styleCount = `color: ${countColor}; opacity: ${opacity};`;
    const styleRevenue = `color: ${revenueColor}; opacity: ${opacity};`;

    // [แก้ไข] เพิ่ม tooltipText เป็นคอลัมน์สุดท้าย
    data.addRow([serviceCodeLabel, count, styleCount, revenue, styleRevenue, tooltipText]);
  });

  // 6. กำหนด Options สำหรับ ComboChart (แนวตั้ง)
  const options = {
    title: `รายละเอียดหัตถการ ${monthFilter ? `(เดือน ${monthFilter})` : '(รวม)'}`,
    legend: { position: 'bottom' },
    chartArea: { width: '85%', height: '65%' },
    backgroundColor: { fill: '#fff' },
    
    // [แก้ไข] vAxis (Vertical) คือแกนแนวนอน (Category)
    // [แก้ไข] hAxis (Horizontal) คือแกนแนวตั้ง (Value)
    // นี่คือ ComboChart แนวตั้ง (Vertical ComboChart)
    
    // [แก้ไข] hAxis (แกน X - แนวนอน) สำหรับ "หัตถการ"
    // เพิ่ม slantedText: true เพื่อแก้ปัญหา Label ทับกัน
    hAxis: { title: 'หัตถการ', slantedText: true, slantAngle: 45 }, 
    
    // [ลบ] ลบ hAxis (singular) ที่ไม่ถูกต้องออก
    // hAxis: { title: 'จำนวน', format: 'short' }, 
    
    seriesType: 'bars', // ประเภทหลักเป็น 'bars'
    series: {
      // [แก้ไข] เพิ่มสีหลักเพื่อให้ Legend ถูกต้อง
      0: { type: 'bars', targetAxisIndex: 0, color: '#10B981' }, // Series 0 (Count) - Green
      1: { type: 'line', targetAxisIndex: 1, color: '#1a73e8' }  // Series 1 (Revenue) - Blue
    },

    // [แก้ไข] กำหนดแกน Y (vAxes ในกราฟแนวตั้ง)
    // เปลี่ยนจาก hAxes เป็น vAxes
    vAxes: {
      0: { title: 'จำนวน (ครั้ง)', textStyle: {color: '#10B981'} }, // แกน 0 (ซ้าย)
      1: { title: 'รายได้ (P/L)', format: 'short', textStyle: {color: '#1a73e8'} } // แกน 1 (ขวา)
    },
  };
  
  // 7. วาดกราฟ
  if (!chartServiceDetails) {
    chartServiceDetails = new google.visualization.ComboChart(container);
    
    // 8. เพิ่ม Event Listener (ครั้งเดียว)
    google.visualization.events.addListener(chartServiceDetails, 'select', function() {
      const sel = chartServiceDetails.getSelection();
      if (sel.length > 0) {
        // sel[0].row คือ index ของแถวที่ถูกคลิก (0-4)
        const row = sel[0].row;
        // [แก้ไข] คำนวณ global index จาก
        const globalIndex = (serviceDetailsPage * SERVICE_PAGE_SIZE) + row;

        if (row != null && sortedServiceSummary[globalIndex]) {
          // ใช้ globalIndex เพื่อหา serviceCode จาก array หลัก
          const selectedServiceCode = sortedServiceSummary[globalIndex].serviceCode;
          
          // Toggle filter
          currentServiceFilter = (currentServiceFilter === selectedServiceCode) ? null : selectedServiceCode;
          
          // วาดทุกอย่างใหม่
          // (การคลิก filter service ไม่ควรรีเซ็ตหน้า)
          drawChartAndTable();
        }
      }
    });
  }
  
  chartServiceDetails.draw(data, options);

  // [เพิ่ม] 9. อัปเดตสถานะปุ่ม Pagination
  try {
    document.getElementById('btn_prev_service').disabled = (serviceDetailsPage === 0);
    document.getElementById('btn_next_service').disabled = (serviceDetailsPage >= totalPages - 1);
    document.getElementById('service_page_indicator').textContent = (totalPages > 0) ? `หน้า ${serviceDetailsPage + 1} / ${totalPages}` : '';
    // แสดง/ซ่อน ปุ่ม
    document.getElementById('service_pagination_controls').style.display = (totalPages > 1) ? 'flex' : 'none';
  } catch (e) {
    console.error("Error updating pagination controls:", e);
  }
}


// --- [ลบ] ฟังก์ชัน updateDetailsTable (ตัวที่สอง) ถูกลบ ---
// (ฟังก์ชันที่เคยอยู่บรรทัด 410-471 ในไฟล์เดิม)


// --- 12. UPDATE FILTER STATUS ---
// (อัปเดตข้อความแสดงสถานะฟิลเตอร์)
function updateFilterStatus(){
  const el=document.getElementById('filter_status'); 
  let text=''; 
  if(currentMonthFilter) text+=`<span class="filter-active p-1 rounded-md">เดือน: <strong>${currentMonthFilter}</strong></span> | `;
  if(currentServiceFilter) text+=`<span class="filter-active p-1 rounded-md">Service: <strong>${currentServiceFilter}</strong></span>`;
  
  let clearBtn = '';
  if (currentMonthFilter || currentServiceFilter) {
     clearBtn = ` <button onclick="clearAllFilters()" class="ml-2 text-xs text-red-600 hover:underline font-semibold">(ล้างตัวกรอง)</button>`;
  }

  // [แก้ไข] ปรับปรุงข้อความเริ่มต้น
  el.innerHTML= (text || '<p class="text-sm text-gray-500 italic">คลิกที่กราฟรายเดือน (เดือน) หรือกราฟหัตถการ (Service) เพื่อกรองข้อมูล</p>') + clearBtn;
}

// --- 13. CLEAR ALL FILTERS ---
// (ฟังก์ชันสำหรับปุ่มล้างตัวกรอง)
function clearAllFilters() {
  currentMonthFilter = null;
  currentServiceFilter = null;
  serviceDetailsPage = 0; // [เพิ่ม] รีเซ็ตหน้า
  // ล้างการไฮไลท์บนกราฟ
  if (chartMonthly) chartMonthly.setSelection([]);
  if (chartCumulative) chartCumulative.setSelection([]);
  if (chartServiceDetails) chartServiceDetails.setSelection([]);
  
  // วาดใหม่ทั้งหมด
  drawChartAndTable();
}

// [เพิ่ม] ฟังก์ชันสำหรับเปลี่ยนหน้าของ Service Chart
function changeServicePage(direction) {
  const newPage = serviceDetailsPage + direction;
  const totalItems = sortedServiceSummary.length;
  const totalPages = Math.ceil(totalItems / SERVICE_PAGE_SIZE);

  // ตรวจสอบว่าหน้าใหม่อยู่ในขอบเขต
  if (newPage >= 0 && newPage < totalPages) {
    serviceDetailsPage = newPage;
    // วาดเฉพาะกราฟหัตถการใหม่ (ไม่จำเป็นต้องโหลดข้อมูลใหม่)
    drawServiceDetailsChart(currentAeTitle, currentMonthFilter, currentServiceFilter);
  }
}
</script>
</body>
</html>